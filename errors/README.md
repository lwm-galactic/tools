# errors 包详解

## 📦 包整体功能概览

该包主要提供了以下几类功能：

| 类型函数                     | 描述                           |
| ---------------------------- | ------------------------------ |
| `New`,`Errorf`               | 创建带堆栈信息的基础错误       |
| `Wrap`,`Wrapf`               | 给已有错误添加上下文并记录堆栈 |
| `WithStack`                  | 单独给错误加上堆栈             |
| `WithMessage`,`WithMessagef` | 给错误加上额外消息（不加堆栈） |
| `WithCode`                   | 带错误码的错误类型（可选堆栈） |
| `Cause`                      | 获取原始错误（剥离所有包装）   |
| `Format`                     | 支持`%+v`打印详细堆栈          |
| `Unwrap`                     | 兼容 Go 1.13 的 error chain    |

## 自定义结构体

### fundamental 一个用于统一封装错误的对象

```go
type fundamental struct {
    msg string //  存储错误信息。
    *stack // 一个指向调用栈的指针（通常是当前 goroutine 的调用栈），用来记录错误发生时的堆栈信息。
}
```

- **作用** ：最基本的错误类型，包含错误信息 + 调用堆栈。
- **使用场景** ：由 `New()` 和 `Errorf()` 返回。
- 方法 ：
  - `Error() string`: 实现 `error` 接口。
  - `Format(...)`: 支持 `fmt.Printf("%+v", err)` 输出堆栈。



### withStack

```go
type withStack struct {
    error
    *stack
}
```

- **作用** ：为任意错误附加调用堆栈。
- 方法 ：
  - `Cause()`: 返回原始错误。
  - `Unwrap()`: 兼容 Go 1.13 的 error chain。
  - `Format(...)`: 如果用 `%+v`，会输出堆栈信息。

### withMessage

```go
type withMessage struct {
    cause error
    msg   string
}
```

- **作用** ：为错误添加额外信息（不加堆栈）。
- 方法 ：
  - `Error()`: 返回新消息。
  - `Cause()`: 返回原始错误。
  - `Unwrap()`: 兼容 Go 1.13。
  - `Format(...)`: 如果用 `%+v`，也会递归打印原始错误的堆栈。



### withCode

```go
type withCode struct {
    err   error
    code  int
    cause error
    *stack
}
```

- **作用** ：带错误码的错误类型，常用于 API 或业务逻辑中的错误分类。
- 支持 ：
  - 可以有堆栈。
  - 可以从另一个错误包装而来。
  - 提供 `code` 字段来标识错误类型 自定义码。



## 代码详解

### Aggregate (聚合错误)

 **错误聚合（Aggregate）处理库** ，用于将多个错误组合成一个整体返回，并支持常见的错误过滤、简化、扁平化等操作。它非常适合在并发任务中收集多个错误并统一处理。

#### 📦 模块概览

这个包的主要功能是：

| 功能         | 描述                                       |
| ------------ | ------------------------------------------ |
| 聚合多个错误 | 支持将多个`error`合并为一个`Aggregate`错误 |
| 兼容标准库   | 支持`errors.Is()`和`errors.As()`           |
| 错误过滤     | 可以通过匹配器（Matcher）移除某些特定错误  |
| 错误简化     | 如果只有一个错误，则直接返回该错误         |
| 并发聚合     | 提供并发安全的错误聚合工具                 |
| 错误计数     | 将错误信息和出现次数映射为 Aggregate       |

### Stack **堆栈追踪功能**

#### 📦 模块概览

这个包主要包含以下几个核心结构和功能：

| 类型         | 描述                                           |
| ------------ | ---------------------------------------------- |
| `Frame`      | 表示一个调用栈帧（某个函数的地址）             |
| `StackTrace` | 一组`Frame`，表示完整的调用栈                  |
| `stack`      | 程序计数器数组（uintptr），用于构建 StackTrace |
| `callers()`  | 获取当前调用栈的程序计数器地址                 |

#### 🖨️ 格式化输出详解

这部分是通过实现 `fmt.Formatter` 接口完成的，使得你可以使用 `fmt.Printf` 等工具打印出丰富的错误堆栈信息。

`Frame.Format(s fmt.State, verb rune)`支持以下格式符：

| 格式符 | 含义                  |
| ------ | --------------------- |
| `%s`   | 文件名（不含路径）    |
| `%+s`  | 函数名 + 完整文件路径 |
| `%d`   | 行号                  |
| `%n`   | 函数名                |
| `%v`   | 等价于`%s:%d`         |
| `%+v`  | 等价于`%+s:%d`        |

`StackTrace.Format(...)`  支持：

| 格式符 | 含义                                       |
| ------ | ------------------------------------------ |
| `%s`   | 所有帧的文件名                             |
| `%v`   | 所有帧的文件名和行号                       |
| `%+v`  | 所有帧的函数名、文件路径和行号（每帧一行） |

### code (错误业务码)

业务码分为三部份

- 错误码编号 (6位数字)
- 用户可见的错误信息  
- 相关文档查询（可选）

```go
// Coder 是所有错误码必须实现的接口
type Coder interface {
	// String 返回用户可见的错误信息
	String() string

	// Reference 返回错误相关的文档地址，用于指导用户解决问题
	Reference() string

	// Code 返回错误码编号
	Code() int
}

```



